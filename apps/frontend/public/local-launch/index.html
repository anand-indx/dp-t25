<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Launching Local Jupyter…</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background: #f8fafc; color: #0f172a; }
      .card { max-width: 720px; margin: 10vh auto; background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 24px; box-shadow: 0 8px 24px rgba(15,23,42,0.06); }
      .muted { color: #475569; }
      code { background: #f1f5f9; padding: 2px 6px; border-radius: 6px; }
      .btn { display: inline-flex; align-items: center; gap: 8px; background: #16a34a; color: #fff; border-radius: 8px; padding: 10px 14px; text-decoration: none; }
      .btn-secondary { background: #0ea5e9; }
      .row { display: flex; gap: 12px; flex-wrap: wrap; }
    </style>
  </head>
  <body>
    <div class="card">
      <h1 style="margin:0 0 8px">Launching Local Jupyter…</h1>
      <p class="muted" id="status">Looking for Jupyter at <code>http://localhost:8888</code>. If it isn't running, start it using Docker below. This page will auto-detect and open your notebook when ready.</p>
      <div style="margin: 12px 0; padding: 12px; background:#f8fafc; border:1px dashed #cbd5e1; border-radius:8px;">
        <div class="muted" style="font-size:14px">Selected notebook:</div>
        <div id="nb" style="font-family: ui-monospace, SFMono-Regular, Menlo, monospace; word-break: break-all;"></div>
      </div>
      <div class="row" style="margin: 16px 0 8px">
        <a id="openDirect" class="btn" href="#" target="_blank" rel="noopener noreferrer">Open Now</a>
        <a id="setup" class="btn btn-secondary" href="../local-setup/" target="_blank" rel="noopener noreferrer">Local Setup</a>
      </div>
      <div class="muted" style="margin-top:12px; font-size:14px">
        Tip: You can start Dockerized Jupyter with <code>./start.sh</code>. Once running, this page will redirect automatically.
      </div>
    </div>
    <script>
      (function(){
        const params = new URLSearchParams(location.search);
        const relPath = params.get('path') || '';
        const target = `http://localhost:8888/lab/tree/notebooks/${relPath}`;
        const api = 'http://localhost:8888/api';
        document.getElementById('nb').textContent = relPath || '(none)';
        document.getElementById('openDirect').href = target;
        const statusEl = document.getElementById('status');

        let tries = 0;
        const maxTries = 60; // ~60s
        const delay = (ms) => new Promise(r => setTimeout(r, ms));

        async function probe(){
          tries++;
          try {
            const ctrl = new AbortController();
            const t = setTimeout(() => ctrl.abort(), 1200);
            await fetch(api, { mode: 'no-cors', signal: ctrl.signal });
            clearTimeout(t);
            // If fetch doesn't throw, assume port is open
            statusEl.textContent = 'Detected local Jupyter. Opening notebook…';
            window.open(target, '_blank', 'noopener,noreferrer');
            return;
          } catch (e) {
            statusEl.textContent = `Waiting for local Jupyter to start (attempt ${tries}/${maxTries})…`;
            if (tries < maxTries) {
              await delay(1000);
              return probe();
            } else {
              statusEl.textContent = 'Could not detect Jupyter at http://localhost:8888. Please start it via Docker (./start.sh) and refresh this page.';
            }
          }
        }
        probe();
      })();
    </script>
  </body>
  </html>
